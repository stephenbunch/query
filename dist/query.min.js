!function(){"use strict";var n,r=!("undefined"!=typeof module&&module.exports),t=r?window.pathy:require("pathy");if(r)n=window._;else try{n=require("lodash"),n=require("underscore")}catch(e){}var u=function(){function r(n){this.iterator=n}function e(n){return function(){var r,t=[],e=!1;return n.on("data",function(n){r?(r.resolve({done:!1,value:n}),r=null):t.push(n)}),n.on("end",function(){e=!0,r&&0===t.length&&(r.resolve({done:!0}),r=null)}),{nextAsync:function(){if(!r){if(t.length>0)return Task.from({done:!1,value:t.shift()});if(e)return Task.from({done:!0});r=new Task}return r.promise}}}}function u(n){this.iterator=n?p(n)?n:s(n)?o(n):i(n):null}function o(n){return function(){var r=n.slice(),t=-1,e=r.length;return{next:function(){return t+=1,{done:t>=e,value:r[t]}}}}}function i(n){return function(){var r=Object.keys(n),t=-1,e=r.length;return{next:function(){return t+=1,{done:t>=e,value:e>t&&{key:r[t],value:n[r[t]]}||null}}}}}function f(n){var r,e,u,o;for(u=Object.keys(h.LogicalOps),r=0,e=u.length;e>r;r++)if(o=u[r],void 0!==n[o])return h.LogicalOps[o](n[o]);var i=Object.keys(h.ComparisonOps),f=Object.keys(h.ElementOps),s=(Object.keys(h.ArrayOps),[]);Object.keys(n).forEach(function(r){var e=t(r),u=n[r];"object"===l(u)?Object.keys(u).forEach(function(n){if(i.indexOf(n)>-1)s.push(c(n,e,u[n]));else if(f.indexOf(n)>-1)s.push(h.ElementOps[n](e));else{if(!(arrayOps.indexOf(n)>-1))throw new Error('Operator "'+n+'" is not supported.');s.push(a(n,e,u[n]))}}):s.push(c("$eq",e,u))});var p=s.length;return function(n){for(var r=0;p>r;r++)if(!s[r](n))return!1;return!0}}function c(n,r,t){var e=h.ComparisonOps[n];return function(n){return e(r.get(n),t)}}function a(n,r,t){var e=h.ArrayOps[n](t);return function(n){return e(r.get(n))}}function s(n){if(!n)return!1;var r=n.length,t=l(n);return"function"===t||"window"===t?!1:1===n.nodeType&&r?!0:"array"===t||0===r||"number"==typeof r&&r>0&&r-1 in n}function l(n){return Object.prototype.toString.call(n).match(/^\[object\s(.*)\]$/)[1].toLowerCase()}function p(r){return"undefined"!=typeof n&&n.isFunction?n.isFunction(r):"function"==typeof r||!1}var h=function(n){return new u(n)};return h.stream=function(n){return new r(e(n))},u.prototype.fork=function(n){var r=this;return new u(function(){return n(r.iterator)})},h.array=function(n){return new u(o(n))},h.object=function(n){return new u(i(n))},u.prototype.where=function(n){return n=h.filterThunk(n),this.fork(function(r){var t=r(),e=-1;return{next:function(){for(;;){var r=t.next();if(r.done)return r;if(e+=1,n(r.value,e))return r}}}})},u.prototype.whereAsync=r.prototype.whereAsync=function(n){var r=h.asyncThunk(h.filterThunk(n));return this.asyncFork(function(n){var t,e=n(),u=-1,o=function(){return t||(t=e.nextAsync().then(function(n){return n.done?n:(u+=1,r(n.value,u).then(function(r){return t=null,r?n:o()}))})),t};return{nextAsync:o}})},h.ArrayOps={$all:function(n){var r=f(n);return function(n){for(var t=0,e=n.length;e>t;t++)if(!r(n[t]))return!1;return!0}},$elemMatch:function(n){var r=f(n);return function(n){for(var t=0,e=n.length;e>t;t++)if(r(n[t]))return!0;return!1}},$size:function(n){return function(r){return r.length===n}}},h.ComparisonOps={$eq:function(n,r){return n===r},$gt:function(n,r){return n>r},$gte:function(n,r){return n>=r},$lt:function(n,r){return r>n},$lte:function(n,r){return r>=n},$ne:function(n,r){return n!==r},$in:function(n,r){return r.indexOf(n)>-1},$nin:function(n,r){return-1===r.indexOf(n)}},h.ElementOps={$exists:function(n){return function(r){return n.exists(r)}}},h.LogicalOps={$or:function(n){var r=n.map(f);return function(n){for(var t=0,e=r.length;e>t;t++)if(r[t](n))return!0;return!1}},$and:function(n){var r=n.map(f);return function(n){for(var t=0,e=r.length;e>t;t++)if(!r[t](n))return!1;return!0}},$not:function(n){var r=f(n);return function(n){return!r(n)}},$nor:function(n){var r=n.map(f);return function(n){for(var t=0,e=r.length;e>t;t++)if(r[t](n))return!1;return!0}}},u.prototype.toArray=function(){for(var n,r=this.iterator(),t=[];!(n=r.next()).done;)t.push(n.value);return t},h.asyncThunk=function(n){return function(){try{var r=n.apply(void 0,arguments);return r&&r.then?r:Task.from(r)}catch(t){return Task.reject(t)}}},h.filterThunk=function(n){return p(n)?n:f(n)},h}();r?("function"==typeof define&&define.amd&&define(function(){return u}),window.query=u):module.exports=u}();